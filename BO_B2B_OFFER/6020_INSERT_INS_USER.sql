-- 6020.
-- USE LEGACY;

-- NAS 10.07 beégetések bõvítése
SET @CUST_TYPE_B2B = LEGACY.CONFIG('CUST_TYPE_B2B',NULL);
SET @OFFER_TYPE_MAIN = LEGACY.CONFIG('OFFER_TYPE_MAIN',NULL);

CALL LEGACY.createindex_ifnotexists('MDM','INS_OFFER','USER_ID');

CALL LEGACY.createindex_ifnotexists('LEGACY','M_USER','CTN');

insert into
MDM.INS_USER 
(
TENANT_ID,
USER_ID,
PROD_CATALOG_ID,
CUST_ID, 
CUST_TYPE,
BILL_ID,
SUB_BILL_ID,
FIRST_USE_DATE,
ACTIVE_DATE,
PRE_DESTORY_TIME, 
LAST_TRANS_DATE, 
STATE,
CREDIT_LEVEL,
OWE_AMOUNT, 
PASSWORD_TYPE,
PASSWORD,
USER_TYPE,
IS_OUT_NET,
OP_ID,
ORG_ID,
DONE_CODE,
CREATE_DATE,
DONE_DATE,
EFFECTIVE_DATE,
EXPIRE_DATE,
REGION_ID,
EFFECTIVE_DATE_TYPE,
EXPIRE_DATE_TYPE,
PREPAY_VALIDITY_DATE,
OS_STATUS
)

SELECT 
  '22' 						TENANT_ID,
	U.Sub_Id				USER_ID,
	'172000000001'	PROD_CATALOG_ID,
	U.CA_Id					CUST_ID,
  @CUST_TYPE_B2B  CUST_TYPE,
	U.CTN						BILL_ID,
	U.IMSI					SUB_BILL_ID,
	U.Init_Act_Dt		FIRST_USE_DATE,
	U.Init_Act_Dt		ACTIVE_DATE,
	U.Exp_Dt				PRE_DESTORY_TIME,
	null						LAST_TRANS_DATE,
	CASE 
    WHEN U.CA_Id='PD_PREACT' THEN '4'
    when U.Exp_Dt > sysdate() THEN '1'
    when U.Sub_Status_Cd = 'C' then '3'
	ELSE '5' 	
	END							STATE,
	null						CREDIT_LEVEL,
	null						OWE_AMOUNT,
	'0'							PASSWORD_TYPE,
	NULL					PASSWORD,
	'1'							USER_TYPE, -- mgy:2016.06.16 group user-ekre 8, és a B2B állítólag ilyen, nk:2016.07.04 nem ilyenek :)
	'0'							IS_OUT_NET,
	null						OP_ID,
	null						ORG_ID,
	null						DONE_CODE,
	U.Eff_Dt				CREATE_DATE,
	U.Eff_Dt				DONE_DATE,
	U.Eff_Dt				EFFECTIVE_DATE,
	U.Exp_Dt				EXPIRE_DATE,
	null						REGION_ID,
	'0'							EFFECTIVE_DATE_TYPE,
	'0'							EXPIRE_DATE_TYPE,
-- NAS 0810	
--	null						PREPAY_VALIDITY_DATE,  
	U.LIFECYCLE_EXP_DATE	PREPAY_VALIDITY_DATE,

	case 
		when Sub_Status_Rsn_Cd in ('KMKA', 'KIME', 'KICS', 'OBAR', 'MOBA')
			then '0000000000000000010000000000000000000000000000000000000000000000'
		when Sub_Status_Rsn_Cd in ('HUSU', 'HUSK', 'LME')
  		then '0000001000000000000000000000000000000000000000000000000000000000'
		when Sub_Status_Rsn_Cd = 'FRAU' 
			then '0000000001000000000000000000000000000000000000000000000000000000'		
		when Sub_Status_Rsn_Cd in ('PSST', 'SST', 'KIST', 'MAKI')
			then '0000000000000000100000000000000000000000000000000000000000000000'

		when Sub_Status_Rsn_Cd in ('CSCR', 'SUSF', 'SUCR', 'TSUS', 'TESZ')
			then '0100000000000000000000000000000000000000000000000000000000000000'
		when Sub_Status_Rsn_Cd in ('SPRE', 'DPRE')
			then '0000000000000000000000000100000000000000000000000000000000000000'		
		else 		 	 '0000000000000000000000000000000000000000000000000000000000000000'
    end 					OS_STATUS
from LEGACY.M_USER U
where Ca_Type_cd = 2 
AND U.Sub_Id IN
(SELECT DISTINCT USER_ID FROM MDM.INS_OFFER O WHERE OFFER_TYPE = @OFFER_TYPE_MAIN) -- 20161005_HL csak main offerekre szûr‚s
;    

